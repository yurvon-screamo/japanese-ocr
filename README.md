# Manga OCR

Высокопроизводительный OCR для распознавания японского текста с изображений манги, написанный на Rust.

## Описание

Manga OCR — это инструмент для оптического распознавания японского текста, оптимизированный для работы с манга-контентом. Проект использует архитектуру VisionEncoderDecoderModel с ONNX-моделями для эффективного инференса на CPU.

### Архитектура модели

- **Энкодер**: ViT (Vision Transformer) на базе `facebook/deit-tiny-patch16-224`
- **Декодер**: BERT на базе `tohoku-nlp/bert-base-japanese-char-v2`
- **Формат**: ONNX для кроссплатформенной совместимости

## Возможности

- Распознавание японского текста с изображений
- Два режима работы: файловый и мониторинг буфера обмена
- Автоматическое копирование результата в буфер обмена
- CPU-инференс без внешних зависимостей

## Установка

### CLI

```bash
cargo install manga-ocr
```

### Библиотека

```bash
cargo add rs-manga-ocr
```

## Использование

### Режим буфера обмена (по умолчанию)

Программа отслеживает буфер обмена и автоматически распознаёт текст с появляющихся изображений:

```bash
manga-ocr
```

Результат распознавания автоматически копируется обратно в буфер обмена.

### Режим работы с файлом

```bash
manga-ocr --mode file --image path/to/image.png
```

### Параметры командной строки

| Параметр                      | Описание                             | По умолчанию |
| ----------------------------- | ------------------------------------ | ------------ |
| `-i, --image <PATH>`          | Путь к изображению для распознавания | —            |
| `--mode <MODE>`               | Режим работы: `file` или `clipboard` | `clipboard`  |
| `--refresh-timeout <SECONDS>` | Интервал опроса буфера обмена        | `1.0`        |

## Структура проекта

```
manga-ocr/
├── rs-manga-ocr/           # Библиотека OCR
│   ├── src/
│   │   ├── lib.rs          # Публичный API
│   │   ├── model.rs        # Реализация модели
│   │   └── error.rs        # Обработка ошибок
│   └── model/              # ONNX модели и токенизатор
│       ├── encoder_model.onnx
│       ├── decoder_model.onnx
│       └── tokenizer.json
├── rs-manga-ocr-cli/       # CLI приложение
│   └── src/
│       ├── main.rs         # Точка входа
│       ├── clipboard.rs    # Работа с буфером обмена
│       └── error.rs        # Обработка ошибок
└── Cargo.toml              # Workspace конфигурация
```

## Технические детали

### Предобработка изображений

- Размер входного изображения: 224×224 пикселя
- Нормализация: mean=[0.5, 0.5, 0.5], std=[0.5, 0.5, 0.5]
- Метод ресайза: Nearest Neighbor

### Генерация текста

- Максимальная длина последовательности: 300 токенов
- Автокорректировка с токенами `[CLS]` (start) и `[SEP]` (end)
- Удаление пробелов из финального результата

### Зависимости

| Библиотека    | Назначение                       |
| ------------- | -------------------------------- |
| `candle-core` | Тензорные вычисления             |
| `candle-onnx` | Работа с ONNX моделями           |
| `tokenizers`  | Токенизация текста (HuggingFace) |
| `image`       | Обработка изображений            |
| `clap`        | Парсинг аргументов CLI           |
| `arboard`     | Работа с буфером обмена          |

## Использование как библиотека

```rust
use rs_manga_ocr::MangaOCRModel;
use image;

fn main() -> Result<(), Box<dyn std::error::Error>> {
    let mut model = MangaOCRModel::load()?;
    let img = image::ImageReader::open("manga.png")?.decode()?;
    let text = model.run(&img)?;
    println!("Распознанный текст: {}", text);
    Ok(())
}
```

Добавьте в `Cargo.toml`:

```toml
[dependencies]
rs-manga-ocr = { path = "path/to/rs-manga-ocr" }
image = "0.25"
```

## Лицензия

Проект распространяется под лицензией GNU AGPL v3. Подробности в файле [LICENSE](LICENSE).
